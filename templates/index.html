<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERS - Investigation Results</title>
    <link rel="stylesheet" href="css/index.css">
    <script>
        // Session ID will be replaced by the script
        const currentSessionId = 'SESSION_ID_PLACEHOLDER';
        
        // Check authentication immediately (before page renders)
        (function() {
            const isAuthenticated = sessionStorage.getItem('ers_authenticated') === 'true';
            const storedSessionId = sessionStorage.getItem('ers_session_id');
            
            if (!isAuthenticated || storedSessionId !== currentSessionId) {
                sessionStorage.clear();
                window.location.replace('lock.html');
                throw new Error('Not authenticated or session expired');
            }
        })();
        
        function logout() {
            sessionStorage.removeItem('ers_authenticated');
            sessionStorage.removeItem('ers_auth_timestamp');
            sessionStorage.removeItem('ers_session_id');
            window.location.replace('lock.html');
        }
        
        // Log file mapping: section ID -> log file name
        const logFiles = {
            'user': 'logs/user.log',
            'command': 'logs/command.log',
            'network': 'logs/network.log',
            'process': 'logs/process.log',
            'startup': 'logs/startup.log',
            'cron': 'logs/cron.log',
            'log': 'logs/log.log',
            'system': 'logs/system.log'
        };
        
        // Function to escape HTML entities
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Function to highlight log content with syntax highlighting
        // Process in order: mark all patterns first, then apply highlights to avoid nesting
        function highlightLogLine(line) {
            if (!line) return ' ';
            
            // Work on original text first, then escape HTML
            // This allows us to use more precise pattern matching
            // Find all matches with their positions and types
            const matches = [];
            
            // Pattern 1: Timestamps with brackets [YYYY-MM-DD HH:MM:SS]
            const timestampBracketPattern = /\[\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}\]/g;
            let match;
            while ((match = timestampBracketPattern.exec(line)) !== null) {
                matches.push({
                    start: match.index,
                    end: match.index + match[0].length,
                    type: 'timestamp',
                    content: match[0]
                });
            }
            
            // Pattern 2: IP addresses (avoid matching inside timestamps)
            const ipPattern = /\b(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})\b/g;
            while ((match = ipPattern.exec(line)) !== null) {
                // Check if this IP is inside a timestamp match
                const insideTimestamp = matches.some(m => 
                    m.type === 'timestamp' && 
                    match.index >= m.start && 
                    match.index + match[0].length <= m.end
                );
                if (!insideTimestamp) {
                    matches.push({
                        start: match.index,
                        end: match.index + match[0].length,
                        type: 'ip',
                        content: match[1]
                    });
                }
            }
            
            // Pattern 3: File paths
            const pathPattern = /(\/[^\s<>"']+|\\[^\s<>"']+)/g;
            while ((match = pathPattern.exec(line)) !== null) {
                const insideMatch = matches.some(m => 
                    match.index >= m.start && 
                    match.index + match[0].length <= m.end
                );
                if (!insideMatch && match[0].length > 1) {
                    matches.push({
                        start: match.index,
                        end: match.index + match[0].length,
                        type: 'path',
                        content: match[0]
                    });
                }
            }
            
            // Pattern 4: ERROR, FATAL, CRITICAL
            const errorPattern = /\b(ERROR|FATAL|CRITICAL|FAILED|FAIL|Exception|Error)\b/gi;
            while ((match = errorPattern.exec(line)) !== null) {
                const insideMatch = matches.some(m => 
                    match.index >= m.start && 
                    match.index + match[0].length <= m.end
                );
                if (!insideMatch) {
                    matches.push({
                        start: match.index,
                        end: match.index + match[0].length,
                        type: 'error',
                        content: match[0]
                    });
                }
            }
            
            // Pattern 5: WARNING, WARN
            const warningPattern = /\b(WARNING|WARN|ALERT)\b/gi;
            while ((match = warningPattern.exec(line)) !== null) {
                const insideMatch = matches.some(m => 
                    match.index >= m.start && 
                    match.index + match[0].length <= m.end
                );
                if (!insideMatch) {
                    matches.push({
                        start: match.index,
                        end: match.index + match[0].length,
                        type: 'warning',
                        content: match[0]
                    });
                }
            }
            
            // Pattern 6: INFO, INFORMATION
            const infoPattern = /\b(INFO|INFORMATION|NOTICE)\b/gi;
            while ((match = infoPattern.exec(line)) !== null) {
                const insideMatch = matches.some(m => 
                    match.index >= m.start && 
                    match.index + match[0].length <= m.end
                );
                if (!insideMatch) {
                    matches.push({
                        start: match.index,
                        end: match.index + match[0].length,
                        type: 'info',
                        content: match[0]
                    });
                }
            }
            
            // Pattern 7: SUCCESS, OK, PASSED
            const successPattern = /\b(SUCCESS|SUCCESSFUL|OK|PASSED|PASS)\b/gi;
            while ((match = successPattern.exec(line)) !== null) {
                const insideMatch = matches.some(m => 
                    match.index >= m.start && 
                    match.index + match[0].length <= m.end
                );
                if (!insideMatch) {
                    matches.push({
                        start: match.index,
                        end: match.index + match[0].length,
                        type: 'success',
                        content: match[0]
                    });
                }
            }
            
            // Sort matches by start position
            matches.sort((a, b) => a.start - b.start);
            
            // Remove overlapping matches (keep the first one)
            const nonOverlappingMatches = [];
            for (let i = 0; i < matches.length; i++) {
                const current = matches[i];
                const overlaps = nonOverlappingMatches.some(m => 
                    !(current.end <= m.start || current.start >= m.end)
                );
                if (!overlaps) {
                    nonOverlappingMatches.push(current);
                }
            }
            
            // Build the highlighted string
            let result = '';
            let currentPos = 0;
            
            nonOverlappingMatches.forEach(match => {
                // Add text before match
                if (match.start > currentPos) {
                    result += escapeHtml(line.substring(currentPos, match.start));
                }
                // Add highlighted match
                result += '<span class="log-' + match.type + '">' + escapeHtml(match.content) + '</span>';
                currentPos = match.end;
            });
            
            // Add remaining text
            if (currentPos < line.length) {
                result += escapeHtml(line.substring(currentPos));
            }
            
            return result || escapeHtml(line);
        }
        
        // Function to render log with line numbers and syntax highlighting
        function renderLog(content) {
            const lines = content.split('\n');
            let lineNumbersHtml = '';
            let contentHtml = '';
            
            lines.forEach((line, index) => {
                const lineNum = index + 1;
                // Ensure empty lines still have consistent height - use non-breaking space
                const lineContent = (line === '' || line === undefined) ? '\u00A0' : line;
                lineNumbersHtml += '<div class="log-line-number">' + lineNum + '</div>';
                const highlightedLine = highlightLogLine(lineContent);
                contentHtml += '<div class="log-line">' + highlightedLine + '</div>';
            });
            
            return `
                <div class="log-toolbar">
                    <div class="log-toolbar-left">
                        <span>${lines.length} line${lines.length !== 1 ? 's' : ''}</span>
                    </div>
                </div>
                <div class="log-viewer">
                    <div class="log-viewer-wrapper">
                        <div class="log-line-numbers">${lineNumbersHtml}</div>
                        <div class="log-text">${contentHtml}</div>
                    </div>
                </div>
            `;
        }
        
        // Function to load log file via fetch API
        async function loadLogFile(sectionId) {
            const logFile = logFiles[sectionId];
            if (!logFile) {
                return; // Not a log section (e.g., dashboard)
            }
            
            const contentElement = document.getElementById(sectionId + '-content');
            if (!contentElement) {
                return;
            }
            
            // Show loading state
            contentElement.innerHTML = '<div class="log-loading">Loading log file</div>';
            
            try {
                const response = await fetch(logFile);
                if (!response.ok) {
                    if (response.status === 404) {
                        contentElement.innerHTML = '<div class="log-empty">No data available</div>';
                } else {
                        contentElement.innerHTML = '<div class="log-empty">Error loading log file: ' + response.status + '</div>';
                    }
                    return;
                }
                
                const text = await response.text();
                
                if (!text || text.trim() === '') {
                    contentElement.innerHTML = '<div class="log-empty">No data available</div>';
                } else {
                    // Render log with syntax highlighting and line numbers
                    contentElement.innerHTML = renderLog(text);
                    
                    // Setup scroll behavior - line numbers and content are in same container so they sync naturally
                    // Just need to prevent overscroll
                    const viewer = contentElement.querySelector('.log-viewer');
                    if (viewer) {
                        // Prevent overscroll by clamping scroll position when it goes out of bounds
                        let isScrolling = false;
                        
                        viewer.addEventListener('scroll', function() {
                            if (isScrolling) return;
                            isScrolling = true;
                            
                            requestAnimationFrame(function() {
                                const currentScroll = viewer.scrollTop;
                                const scrollHeight = viewer.scrollHeight;
                                const clientHeight = viewer.clientHeight;
                                const maxScroll = Math.max(0, scrollHeight - clientHeight);
                                
                                // Clamp scroll to valid range
                                if (currentScroll < 0) {
                                    viewer.scrollTop = 0;
                                } else if (currentScroll > maxScroll) {
                                    viewer.scrollTop = maxScroll;
                                }
                                
                                isScrolling = false;
                            });
                        }, { passive: true });
                    }
                }
            } catch (error) {
                console.error('Error loading log file:', error);
                contentElement.innerHTML = '<div class="log-empty">Error loading log file: ' + error.message + '</div>';
            }
        }
        
        // Define showSection function and make it global
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.nav-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected section
            const section = document.getElementById(sectionId);
            if (section) {
                section.classList.add('active');
            }
            
            // Add active class to corresponding button
            const buttons = document.querySelectorAll('.nav-button');
            buttons.forEach(btn => {
                if (btn.getAttribute('onclick') && btn.getAttribute('onclick').includes(sectionId)) {
                    btn.classList.add('active');
                }
            });
            
            // Load log file if this is a log section
            if (logFiles[sectionId]) {
                loadLogFile(sectionId);
            }
        }
        
        // Make showSection available globally for onclick handlers
        window.showSection = showSection;
        
        // Initialize: show dashboard by default
        document.addEventListener('DOMContentLoaded', function() {
            // Show dashboard on load
            showSection('dashboard');
        });
    </script>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>ERS</h2>
            <div class="subtitle">Emergency Response Script</div>
        </div>
        <ul class="nav-menu">
            <li class="nav-item">
                <button class="nav-button active" onclick="showSection('dashboard')">Dashboard</button>
            </li>
            <li class="nav-item">
                <button class="nav-button" onclick="showSection('user')">User</button>
            </li>
            <li class="nav-item">
                <button class="nav-button" onclick="showSection('command')">Command</button>
            </li>
            <li class="nav-item">
                <button class="nav-button" onclick="showSection('network')">Network</button>
            </li>
            <li class="nav-item">
                <button class="nav-button" onclick="showSection('process')">Process</button>
            </li>
            <li class="nav-item">
                <button class="nav-button" onclick="showSection('startup')">Startup</button>
            </li>
            <li class="nav-item">
                <button class="nav-button" onclick="showSection('cron')">Cron</button>
            </li>
            <li class="nav-item">
                <button class="nav-button" onclick="showSection('log')">Log</button>
            </li>
            <li class="nav-item">
                <button class="nav-button" onclick="showSection('system')">System</button>
            </li>
        </ul>
        <div class="logout-section">
                <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </div>
            
    <!-- Main Content -->
    <div class="main-content">
        <div class="header">
            <h1>Emergency Response Script - Investigation Results</h1>
            <div class="header-info">
                <div class="info-card">
                    <strong>Timestamp:</strong>
                    <span>TIMESTAMP_PLACEHOLDER</span>
                </div>
                <div class="info-card">
                    <strong>Investigation Level:</strong>
                    <span>LEVEL_PLACEHOLDER</span>
                </div>
                <div class="info-card">
                    <strong>System Type:</strong>
                    <span>SYSTEM_PLACEHOLDER</span>
                </div>
                <div class="info-card">
                    <strong>Generated:</strong>
                    <span>DATE_PLACEHOLDER</span>
                </div>
            </div>
            <div class="password-warning">
                Access Password: PASSWORD_DISPLAY_PLACEHOLDER (Keep this secure!)
            </div>
        </div>
        
        <!-- Dashboard -->
        <div id="dashboard" class="content-section active">
            <h2 class="section-title">Dashboard</h2>
            <div class="dashboard">
                <div class="dashboard-card" onclick="showSection('user')">
                    <span class="badge badge-user">User</span>
                    <h3>User Investigation</h3>
                    <div class="preview">View user accounts, login history, permissions, and more...</div>
        </div>
                <div class="dashboard-card" onclick="showSection('command')">
                    <span class="badge badge-command">Command</span>
                    <h3>Command Investigation</h3>
                    <div class="preview">View command execution history, suspicious commands, and more...</div>
            </div>
                <div class="dashboard-card" onclick="showSection('network')">
                    <span class="badge badge-network">Network</span>
                    <h3>Network Investigation</h3>
                    <div class="preview">View network connections, port listeners, network activity, and more...</div>
</div>
                <div class="dashboard-card" onclick="showSection('process')">
                    <span class="badge badge-process">Process</span>
                    <h3>Process Investigation</h3>
                    <div class="preview">View process information, resource usage, suspicious processes, and more...</div>
        </div>
                <div class="dashboard-card" onclick="showSection('startup')">
                    <span class="badge badge-startup">Startup</span>
                    <h3>Startup Investigation</h3>
                    <div class="preview">View startup items, services, auto-start programs, and more...</div>
            </div>
                <div class="dashboard-card" onclick="showSection('cron')">
                    <span class="badge badge-cron">Cron</span>
                    <h3>Cron Investigation</h3>
                    <div class="preview">View cron jobs, scheduled tasks, and more...</div>
</div>
                <div class="dashboard-card" onclick="showSection('log')">
                    <span class="badge badge-log">Log</span>
                    <h3>Log Investigation</h3>
                    <div class="preview">View system logs, application logs, security logs, and more...</div>
        </div>
                <div class="dashboard-card" onclick="showSection('system')">
                    <span class="badge badge-system">System</span>
                    <h3>System Investigation</h3>
                    <div class="preview">View system information, hardware information, system configuration, and more...</div>
            </div>
</div>
        </div>
        
        <!-- User Section -->
        <div id="user" class="content-section">
            <h2 class="section-title">User Investigation</h2>
            <div class="log-content" id="user-content"><div class="log-empty">Click User in sidebar to load logs...</div></div>
            </div>
        
        <!-- Command Section -->
        <div id="command" class="content-section">
            <h2 class="section-title">Command Investigation</h2>
            <div class="log-content" id="command-content"><div class="log-empty">Click Command in sidebar to load logs...</div></div>
</div>
        
        <!-- Network Section -->
        <div id="network" class="content-section">
            <h2 class="section-title">Network Investigation</h2>
            <div class="log-content" id="network-content"><div class="log-empty">Click Network in sidebar to load logs...</div></div>
        </div>
        
        <!-- Process Section -->
        <div id="process" class="content-section">
            <h2 class="section-title">Process Investigation</h2>
            <div class="log-content" id="process-content"><div class="log-empty">Click Process in sidebar to load logs...</div></div>
            </div>
        
        <!-- Startup Section -->
        <div id="startup" class="content-section">
            <h2 class="section-title">Startup Investigation</h2>
            <div class="log-content" id="startup-content"><div class="log-empty">Click Startup in sidebar to load logs...</div></div>
        </div>
        
        <!-- Cron Section -->
        <div id="cron" class="content-section">
            <h2 class="section-title">Cron Investigation</h2>
            <div class="log-content" id="cron-content"><div class="log-empty">Click Cron in sidebar to load logs...</div></div>
        </div>
        
        <!-- Log Section -->
        <div id="log" class="content-section">
            <h2 class="section-title">Log Investigation</h2>
            <div class="log-content" id="log-content"><div class="log-empty">Click Log in sidebar to load logs...</div></div>
        </div>
        
        <!-- System Section -->
        <div id="system" class="content-section">
            <h2 class="section-title">System Investigation</h2>
            <div class="log-content" id="system-content"><div class="log-empty">Click System in sidebar to load logs...</div></div>
        </div>
        
        <div class="footer">
            <p><strong>Emergency Response Script</strong> - Mining Incident Response System</p>
            <p>Generated by ERS System | Security Investigation Tool</p>
        </div>
    </div>
</body>
</html>
